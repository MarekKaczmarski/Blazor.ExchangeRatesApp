@page "/currency-calculator"
@using ExchangeRatesApp.Client.Services
@using ExchangeRatesApp.Client.Helpers
@using ExchangeRatesApp.Models
@using Color = MudBlazor.Color;
@inject ICurrencyService CurrencyService

<h3>Kalkulator Walutowy</h3>

@* <MudSelect @bind-Value="@sourceCurrencyCode" Label="Z waluty" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
    @if (currencies != null)
    {
        @foreach (var currency in currencies.SelectMany(cr => cr.Rates))
        {
            <MudSelectItem Value="@(currency.Code)">
                <img src="/images/flags/@CurrencyHelper.GetFlagImageName(currency.Code)" height="14" class="mr-1" /> @currency.Code
            </MudSelectItem>
        }
    }
</MudSelect>

<MudNumericField @bind-Value="amountToConvert" Label="Wprowadź wartość" Variant="Variant.Outlined" @oninput="ConvertCurrency" />

<MudSelect @bind-Value="@targetCurrencyCode" Label="Na walutę" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
    @if (currencies != null)
    {
        @foreach (var currency in currencies.SelectMany(cr => cr.Rates))
        {
            <MudSelectItem Value="@currency.Code">
                <img src="/images/flags/@CurrencyHelper.GetFlagImageName(currency.Code)" alt="@currency.Code" height="14" class="mr-1" /> @currency.Code
            </MudSelectItem>
        }
    }
</MudSelect> *@

@* <MudItem xs="12" sm="6" md="4">
    <MudAutocomplete T="string" Label="Z waluty" @bind-Value="sourceCurrencyCode" SearchFunc="@Search1" Variant="Variant.Outlined" />
</MudItem>

<MudItem xs="12" sm="6" md="4">
    <MudAutocomplete T="string" Label="Na walutę" @bind-Value="targetCurrencyCode" SearchFunc="@Search1" Variant="Variant.Outlined" />
</MudItem> *@

<MudGrid>
    <MudItem xs="12" sm="6" md="4">
        <MudAutocomplete @bind-Value="@sourceCurrencyCode" Label="Z waluty" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" SearchFunc="SearchCurrency">
            @if (currencies != null)
            {
                var uniqueCurrencies = currencies.SelectMany(cr => cr.Rates).GroupBy(rate => rate.Code).Select(group => group.First());

                foreach (var currency in uniqueCurrencies)
                {
                    <MudSelectItem Value="@currency.Code">
                        <img src="/images/flags/@CurrencyHelper.GetFlagImageName(currency.Code)" height="14" class="mr-1" /> @currency.Code
                    </MudSelectItem>
                }
            }
        </MudAutocomplete>
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudNumericField @bind-Value="amountToConvert" Label="Wprowadź wartość" Variant="Variant.Outlined" @oninput="ConvertCurrency" />
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudAutocomplete @bind-Value="@targetCurrencyCode" Label="Na walutę" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" SearchFunc="SearchCurrency">
            @if (currencies != null)
            {
                var uniqueCurrencies = currencies.SelectMany(cr => cr.Rates).GroupBy(rate => rate.Code).Select(group => group.First());

                foreach (var currency in uniqueCurrencies)
                {
                    <MudSelectItem Value="@currency.Code">
                        <img src="/images/flags/@CurrencyHelper.GetFlagImageName(currency.Code)" height="14" class="mr-1" /> @currency.Code
                    </MudSelectItem>
                }
            }
        </MudAutocomplete>
    </MudItem>
</MudGrid>

<MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Calculate" Color="Color.Primary" OnClick="ConvertCurrency">Przewalutuj</MudButton>
<MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.SwapVert" Color="Color.Primary" OnClick="SwapCurrencies">Zamień</MudButton> 

<MudPaper>
    <MudTypography Variant="Variant.H6" Class="mt-2">Wynik:</MudTypography>
    <div class="mt-1">
        @result
    </div>
</MudPaper>

@code {
    private List<CurrencyRates> currencies;
    private string sourceCurrencyCode = "";
    private string targetCurrencyCode = "";
    private string result;

    private string selectedSourceCurrency;
    private string selectedTargetCurrency;

    private double amountToConvert = 1.0; // Domyślna wartość 1.0

    protected override async Task OnInitializedAsync()
    {
        currencies = await CurrencyService.GetAllCurrenciesFromAllTables();
    }

    private async Task ConvertCurrency()
    {
        if (currencies != null)
        {
            if (sourceCurrencyCode == targetCurrencyCode)
            {
                result = "Wybrano dwie takie same waluty.";
                return;
            }

            var sourceCurrency = currencies
                .SelectMany(cr => cr.Rates)
                .FirstOrDefault(rate => rate.Code == sourceCurrencyCode);

            var targetCurrency = currencies
                .SelectMany(cr => cr.Rates)
                .FirstOrDefault(rate => rate.Code == targetCurrencyCode);

            if (sourceCurrency != null && targetCurrency != null)
            {
                var convertedAmount = CalculateConvertedAmount(sourceCurrency, targetCurrency);
                result = $"{amountToConvert} {sourceCurrencyCode} = {convertedAmount} {targetCurrencyCode}";
            }
        }
    }

    private double CalculateConvertedAmount(Rate sourceCurrency, Rate targetCurrency)
    {
        double convertedAmount = (amountToConvert * sourceCurrency.Mid) / targetCurrency.Mid;
        convertedAmount = Math.Round(convertedAmount, 2);

        return convertedAmount;
    }

    private void SwapCurrencies()
    {
        string temp = sourceCurrencyCode;
        sourceCurrencyCode = targetCurrencyCode;
        targetCurrencyCode = temp;
        ConvertCurrency(); // Dodane wywołanie konwersji po zamianie walut
    }

    private async Task<IEnumerable<string>> SearchCurrency(string text)
    {
        if (currencies == null)
        {
            return new List<string>();
        }

        return await Task.FromResult(currencies
            .SelectMany(cr => cr.Rates)
            .Where(rate => rate.Code.Contains(text, StringComparison.InvariantCultureIgnoreCase))
            .Select(rate => rate.Code));
    }
}

